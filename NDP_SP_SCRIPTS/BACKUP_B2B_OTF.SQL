CREATE OR REPLACE PROCEDURE "BACKUP_B2B_OTF" (
v_retention IN NUMBER
)
AS
CURSOR OPEN_ENDED_CAMPAIGNS IS
        SELECT CAMPAIGN_ID from ADM_CAMPAIGNS WHERE IS_OPEN_ENDED=1;
RUN_ID NUMBER;
BEGIN
 SELECT H_SP_EXEC_TIME_RUN_SEQ.nextval INTO RUN_ID FROM dual;
 LOG_H_SP_EXEC_TIME(RUN_ID, 'BACKUP_B2B_OTF', systimestamp, null);
FOR CAMP IN OPEN_ENDED_CAMPAIGNS
    LOOP
    BEGIN
		LOG_H_SP_EXEC_TIME(RUN_ID, 'BACKUP_B2B_OTF_' || CAMP.CAMPAIGN_ID || '_0', systimestamp, null);
        INSERT /*+APPEND*/  INTO H_B2B_OTF_DIAL_INFO SELECT * FROM B2B_OTF_DIAL_INFO WHERE CAMPAIGN_ID = CAMP.CAMPAIGN_ID AND MSISDN_LAST_DIG = '0' AND trunc(CREATE_DATE) < trunc(sysdate-v_retention) AND BATCH_ID IS NOT NULL;
        DELETE FROM B2B_OTF_DIAL_INFO WHERE CAMPAIGN_ID = CAMP.CAMPAIGN_ID AND MSISDN_LAST_DIG = '0' AND trunc(CREATE_DATE) < trunc(sysdate-v_retention) AND BATCH_ID IS NOT NULL;
		COMMIT;
		LOG_H_SP_EXEC_TIME(RUN_ID, 'BACKUP_B2B_OTF_' || CAMP.CAMPAIGN_ID || '_0', null, systimestamp);
		
		
		LOG_H_SP_EXEC_TIME(RUN_ID, 'BACKUP_B2B_OTF_' || CAMP.CAMPAIGN_ID || '_1', systimestamp, null);
		INSERT /*+APPEND*/ INTO H_B2B_OTF_DIAL_INFO SELECT * FROM B2B_OTF_DIAL_INFO WHERE CAMPAIGN_ID = CAMP.CAMPAIGN_ID AND MSISDN_LAST_DIG = '1' AND trunc(CREATE_DATE) < trunc(sysdate-v_retention) AND BATCH_ID IS NOT NULL;
        DELETE FROM B2B_OTF_DIAL_INFO WHERE CAMPAIGN_ID = CAMP.CAMPAIGN_ID AND MSISDN_LAST_DIG = '1' AND trunc(CREATE_DATE) < trunc(sysdate-v_retention) AND BATCH_ID IS NOT NULL;
        COMMIT;
		LOG_H_SP_EXEC_TIME(RUN_ID, 'BACKUP_B2B_OTF_' || CAMP.CAMPAIGN_ID || '_1', null, systimestamp);
        
		
		LOG_H_SP_EXEC_TIME(RUN_ID, 'BACKUP_B2B_OTF_' || CAMP.CAMPAIGN_ID || '_2', systimestamp, null);
		INSERT /*+APPEND*/ INTO H_B2B_OTF_DIAL_INFO SELECT * FROM B2B_OTF_DIAL_INFO WHERE CAMPAIGN_ID = CAMP.CAMPAIGN_ID AND MSISDN_LAST_DIG = '2' AND trunc(CREATE_DATE) < trunc(sysdate-v_retention) AND BATCH_ID IS NOT NULL;
        DELETE FROM B2B_OTF_DIAL_INFO WHERE CAMPAIGN_ID = CAMP.CAMPAIGN_ID AND MSISDN_LAST_DIG = '2' AND trunc(CREATE_DATE) < trunc(sysdate-v_retention) AND BATCH_ID IS NOT NULL;
        COMMIT;
		LOG_H_SP_EXEC_TIME(RUN_ID, 'BACKUP_B2B_OTF_' || CAMP.CAMPAIGN_ID || '_2', null, systimestamp);


        LOG_H_SP_EXEC_TIME(RUN_ID, 'BACKUP_B2B_OTF_' || CAMP.CAMPAIGN_ID || '_3', systimestamp, null);
     	INSERT /*+APPEND*/ INTO H_B2B_OTF_DIAL_INFO SELECT * FROM B2B_OTF_DIAL_INFO WHERE CAMPAIGN_ID = CAMP.CAMPAIGN_ID AND MSISDN_LAST_DIG = '3' AND trunc(CREATE_DATE) < trunc(sysdate-v_retention) AND BATCH_ID IS NOT NULL;
        DELETE FROM B2B_OTF_DIAL_INFO WHERE CAMPAIGN_ID = CAMP.CAMPAIGN_ID AND MSISDN_LAST_DIG = '3' AND trunc(CREATE_DATE) < trunc(sysdate-v_retention) AND BATCH_ID IS NOT NULL;
        COMMIT;
		LOG_H_SP_EXEC_TIME(RUN_ID, 'BACKUP_B2B_OTF_' || CAMP.CAMPAIGN_ID || '_3', null, systimestamp);


        LOG_H_SP_EXEC_TIME(RUN_ID, 'BACKUP_B2B_OTF_' || CAMP.CAMPAIGN_ID || '_4', systimestamp, null);
     	INSERT /*+APPEND*/ INTO H_B2B_OTF_DIAL_INFO SELECT * FROM B2B_OTF_DIAL_INFO WHERE CAMPAIGN_ID = CAMP.CAMPAIGN_ID AND MSISDN_LAST_DIG = '4' AND trunc(CREATE_DATE) < trunc(sysdate-v_retention) AND BATCH_ID IS NOT NULL;
        DELETE FROM B2B_OTF_DIAL_INFO WHERE CAMPAIGN_ID = CAMP.CAMPAIGN_ID AND MSISDN_LAST_DIG = '4' AND trunc(CREATE_DATE) < trunc(sysdate-v_retention) AND BATCH_ID IS NOT NULL;
        COMMIT;
		LOG_H_SP_EXEC_TIME(RUN_ID, 'BACKUP_B2B_OTF_' || CAMP.CAMPAIGN_ID || '_4', null, systimestamp);



        LOG_H_SP_EXEC_TIME(RUN_ID, 'BACKUP_B2B_OTF_' || CAMP.CAMPAIGN_ID || '_5', systimestamp, null);
		INSERT /*+APPEND*/ INTO H_B2B_OTF_DIAL_INFO SELECT * FROM B2B_OTF_DIAL_INFO WHERE CAMPAIGN_ID = CAMP.CAMPAIGN_ID AND MSISDN_LAST_DIG = '5' AND trunc(CREATE_DATE) < trunc(sysdate-v_retention) AND BATCH_ID IS NOT NULL;
        DELETE FROM B2B_OTF_DIAL_INFO WHERE CAMPAIGN_ID = CAMP.CAMPAIGN_ID AND MSISDN_LAST_DIG = '5' AND trunc(CREATE_DATE) < trunc(sysdate-v_retention) AND BATCH_ID IS NOT NULL;
        COMMIT;     
		LOG_H_SP_EXEC_TIME(RUN_ID, 'BACKUP_B2B_OTF_' || CAMP.CAMPAIGN_ID || '_5', null, systimestamp);
     

		LOG_H_SP_EXEC_TIME(RUN_ID, 'BACKUP_B2B_OTF_' || CAMP.CAMPAIGN_ID || '_6', systimestamp, null);
		INSERT /*+APPEND*/ INTO H_B2B_OTF_DIAL_INFO SELECT * FROM B2B_OTF_DIAL_INFO WHERE CAMPAIGN_ID = CAMP.CAMPAIGN_ID AND MSISDN_LAST_DIG = '6' AND trunc(CREATE_DATE) < trunc(sysdate-v_retention) AND BATCH_ID IS NOT NULL;
        DELETE FROM B2B_OTF_DIAL_INFO WHERE CAMPAIGN_ID = CAMP.CAMPAIGN_ID AND MSISDN_LAST_DIG = '6' AND trunc(CREATE_DATE) < trunc(sysdate-v_retention) AND BATCH_ID IS NOT NULL;
        COMMIT;    
		LOG_H_SP_EXEC_TIME(RUN_ID, 'BACKUP_B2B_OTF_' || CAMP.CAMPAIGN_ID || '_6', null, systimestamp);
 
 
        LOG_H_SP_EXEC_TIME(RUN_ID, 'BACKUP_B2B_OTF_' || CAMP.CAMPAIGN_ID || '_7', systimestamp, null);
		INSERT /*+APPEND*/ INTO H_B2B_OTF_DIAL_INFO SELECT * FROM B2B_OTF_DIAL_INFO WHERE CAMPAIGN_ID = CAMP.CAMPAIGN_ID AND MSISDN_LAST_DIG = '7' AND trunc(CREATE_DATE) < trunc(sysdate-v_retention) AND BATCH_ID IS NOT NULL;
        DELETE FROM B2B_OTF_DIAL_INFO WHERE CAMPAIGN_ID = CAMP.CAMPAIGN_ID AND MSISDN_LAST_DIG = '7' AND trunc(CREATE_DATE) < trunc(sysdate-v_retention) AND BATCH_ID IS NOT NULL;
        COMMIT;     
		LOG_H_SP_EXEC_TIME(RUN_ID, 'BACKUP_B2B_OTF_' || CAMP.CAMPAIGN_ID || '_7', null, systimestamp);
       
	   
	   LOG_H_SP_EXEC_TIME(RUN_ID, 'BACKUP_B2B_OTF_' || CAMP.CAMPAIGN_ID || '_8', systimestamp, null);
     INSERT /*+APPEND*/ INTO H_B2B_OTF_DIAL_INFO SELECT * FROM B2B_OTF_DIAL_INFO WHERE CAMPAIGN_ID = CAMP.CAMPAIGN_ID AND MSISDN_LAST_DIG = '8' AND trunc(CREATE_DATE) < trunc(sysdate-v_retention) AND BATCH_ID IS NOT NULL;
        DELETE FROM B2B_OTF_DIAL_INFO WHERE CAMPAIGN_ID = CAMP.CAMPAIGN_ID AND MSISDN_LAST_DIG = '8' AND trunc(CREATE_DATE) < trunc(sysdate-v_retention) AND BATCH_ID IS NOT NULL;
        COMMIT;
		LOG_H_SP_EXEC_TIME(RUN_ID, 'BACKUP_B2B_OTF_' || CAMP.CAMPAIGN_ID || '_8', null, systimestamp);
		 

		LOG_H_SP_EXEC_TIME(RUN_ID, 'BACKUP_B2B_OTF_' || CAMP.CAMPAIGN_ID || '_9', systimestamp, null);
     	INSERT /*+APPEND*/ INTO H_B2B_OTF_DIAL_INFO SELECT * FROM B2B_OTF_DIAL_INFO WHERE CAMPAIGN_ID = CAMP.CAMPAIGN_ID AND MSISDN_LAST_DIG = '9' AND trunc(CREATE_DATE) < trunc(sysdate-v_retention) AND BATCH_ID IS NOT NULL;
        DELETE FROM B2B_OTF_DIAL_INFO WHERE CAMPAIGN_ID = CAMP.CAMPAIGN_ID AND MSISDN_LAST_DIG = '9' AND trunc(trunc(CREATE_DATE)) < trunc(sysdate-v_retention) AND BATCH_ID IS NOT NULL;
		COMMIT;
		LOG_H_SP_EXEC_TIME(RUN_ID, 'BACKUP_B2B_OTF_' || CAMP.CAMPAIGN_ID || '_9', null, systimestamp);
	
    END;
    END LOOP;
	
	 LOG_H_SP_EXEC_TIME(RUN_ID, 'BACKUP_B2B_OTF', null, systimestamp);
END;

