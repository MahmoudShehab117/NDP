CREATE OR REPLACE PROCEDURE "IMMEDIATE_BACKUP_B2B_OTF" AS
historyDate varchar2(30);
newTableName varchar2(30);
RUN_ID NUMBER;
BEGIN
 SELECT H_SP_EXEC_TIME_RUN_SEQ.nextval INTO RUN_ID FROM dual;
 LOG_H_SP_EXEC_TIME(RUN_ID, 'IMMEDIATE_BACKUP_B2B_OTF', systimestamp, null);
historyDate := TO_CHAR(sysdate,'yyyymmdd');-- can be replaced with '20200101' for a specific date.
newTableName := 'B2B_OTF_DIAL_INFO'||historyDate;
EXECUTE IMMEDIATE 'ALTER TABLE B2B_OTF_DIAL_INFO RENAME TO '|| newtablename;
EXECUTE IMMEDIATE 'CREATE TABLE B2B_OTF_DIAL_INFO
(
  CAMPAIGN_ID      NUMBER(38)                   NOT NULL,
  MSISDN           VARCHAR2(20 BYTE)            NOT NULL,
  PARAMETERS       VARCHAR2(2000 BYTE),
  MSISDN_LAST_DIG  VARCHAR2(20 BYTE)            NOT NULL,
  BATCH_ID         NUMBER,
  START_FROM       DATE,
  ORDER_ID         NUMBER                       DEFAULT "B2B_OTF_DIAL_INFO_ORDER_SEQ"."NEXTVAL" NOT NULL,
  CREATE_DATE      DATE                         DEFAULT sysdate,
  PROCESS_ID       NUMBER(38)
)
PARTITION BY RANGE (CAMPAIGN_ID)
INTERVAL(1)
SUBPARTITION BY LIST (MSISDN_LAST_DIG)
SUBPARTITION TEMPLATE
  (SUBPARTITION SUB_0 VALUES (''0''),
   SUBPARTITION SUB_1 VALUES (''1''),
   SUBPARTITION SUB_2 VALUES (''2''),
   SUBPARTITION SUB_3 VALUES (''3''),
   SUBPARTITION SUB_4 VALUES (''4''),
   SUBPARTITION SUB_5 VALUES (''5''),
   SUBPARTITION SUB_6 VALUES (''6''),
   SUBPARTITION SUB_7 VALUES (''7''),
   SUBPARTITION SUB_8 VALUES (''8''),
   SUBPARTITION SUB_9 VALUES (''9'')
  )
(PARTITION INVALID VALUES LESS THAN (0)
(SUBPARTITION INVALID_SUB_0 VALUES (''0''),
   SUBPARTITION INVALID_SUB_1 VALUES (''1''),
   SUBPARTITION INVALID_SUB_2 VALUES (''2''),
   SUBPARTITION INVALID_SUB_3 VALUES (''3''),
   SUBPARTITION INVALID_SUB_4 VALUES (''4''),
   SUBPARTITION INVALID_SUB_5 VALUES (''5''),
   SUBPARTITION INVALID_SUB_6 VALUES (''6''),
   SUBPARTITION INVALID_SUB_7 VALUES (''7''),
   SUBPARTITION INVALID_SUB_8 VALUES (''8''),
   SUBPARTITION INVALID_SUB_9 VALUES (''9'')
   )
)';


EXECUTE IMMEDIATE 'ALTER INDEX B2B_BATCHID_IDX RENAME TO B2B_BATCHID_IDX_'||historyDate;

EXECUTE IMMEDIATE 'CREATE INDEX B2B_BATCHID_IDX ON B2B_OTF_DIAL_INFO (BATCH_ID DESC) LOCAL NOPARALLEL';

EXECUTE IMMEDIATE 'INSERT INTO H_B2B_OTF_DIAL_INFO SELECT * FROM '|| newtablename;
COMMIT;
EXECUTE IMMEDIATE 'TRUNCATE TABLE '||newtablename ;

 LOG_H_SP_EXEC_TIME(RUN_ID, 'IMMEDIATE_BACKUP_B2B_OTF', null, systimestamp);
END;
